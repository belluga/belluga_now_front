name: Dispatch Docker Submodule Sync

on:
  workflow_run:
    workflows:
      - Flutter Web Artifact Publish
    types:
      - completed
  workflow_dispatch:

concurrency:
  group: dispatch-docker-sync-${{ github.event.workflow_run.head_branch || github.ref_name }}
  cancel-in-progress: true

jobs:
  dispatch:
    name: Notify docker repo to open/update submodule pin PR
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'workflow_run' &&
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        contains(fromJson('["dev","stage","main"]'), github.event.workflow_run.head_branch)
      )
    env:
      # Prefer a dedicated dispatch token, but allow reusing the shared ecosystem token
      # to avoid mandatory secret renames across repos.
      DOCKER_REPO_DISPATCH_TOKEN: ${{ secrets.DOCKER_REPO_DISPATCH_TOKEN || secrets.SUBMODULES_REPO_TOKEN || secrets.WEB_APP_REPO_TOKEN }}
      DOCKER_SYNC_TARGET_REPO: ${{ vars.DOCKER_SYNC_TARGET_REPO }}
      DOCKER_SYNC_SUBMODULE_PATH: ${{ vars.DOCKER_SYNC_SUBMODULE_PATH }}
      DOCKER_SYNC_EVENT_TYPE: ${{ vars.DOCKER_SYNC_EVENT_TYPE }}

    steps:
      - name: Validate dispatch configuration
        id: config
        run: |
          set -euo pipefail

          missing=()

          if [[ -z "${DOCKER_REPO_DISPATCH_TOKEN:-}" ]]; then
            missing+=("DOCKER_REPO_DISPATCH_TOKEN")
          fi

          if [[ -z "${DOCKER_SYNC_TARGET_REPO:-}" ]]; then
            missing+=("DOCKER_SYNC_TARGET_REPO")
          fi

          if [[ -z "${DOCKER_SYNC_SUBMODULE_PATH:-}" ]]; then
            missing+=("DOCKER_SYNC_SUBMODULE_PATH")
          fi

          if [[ ${#missing[@]} -gt 0 ]]; then
            echo "ERROR: missing dispatch configuration (${missing[*]})." >&2
            echo "Required: secret DOCKER_REPO_DISPATCH_TOKEN (or fallback SUBMODULES_REPO_TOKEN / WEB_APP_REPO_TOKEN) and repository variables DOCKER_SYNC_TARGET_REPO + DOCKER_SYNC_SUBMODULE_PATH." >&2
            exit 1
          fi

          event_type="${DOCKER_SYNC_EVENT_TYPE:-submodule-updated}"

          echo "target_repo=${DOCKER_SYNC_TARGET_REPO}" >> "$GITHUB_OUTPUT"
          echo "submodule=${DOCKER_SYNC_SUBMODULE_PATH}" >> "$GITHUB_OUTPUT"
          echo "event_type=${event_type}" >> "$GITHUB_OUTPUT"

      - name: Resolve source revision
        id: source
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_run" ]]; then
            sha="${{ github.event.workflow_run.head_sha }}"
            lane="${{ github.event.workflow_run.head_branch }}"
            source_repo="${{ github.event.workflow_run.repository.full_name }}"
          else
            sha="${GITHUB_SHA}"
            lane="${GITHUB_REF_NAME}"
            source_repo="${GITHUB_REPOSITORY}"
          fi

          case "$lane" in
            dev|stage|main) ;;
            *)
              echo "ERROR: unsupported source lane '$lane'. Allowed lanes: dev, stage, main." >&2
              exit 1
              ;;
          esac

          if [[ ! "${sha}" =~ ^[0-9a-f]{40}$ ]]; then
            echo "ERROR: invalid source SHA '${sha}'." >&2
            exit 1
          fi

          echo "sha=${sha}" >> "$GITHUB_OUTPUT"
          echo "lane=${lane}" >> "$GITHUB_OUTPUT"
          echo "source_repo=${source_repo}" >> "$GITHUB_OUTPUT"

      - name: Dispatch repository event
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ env.DOCKER_REPO_DISPATCH_TOKEN }}
          repository: ${{ steps.config.outputs.target_repo }}
          event-type: ${{ steps.config.outputs.event_type }}
          client-payload: >-
            {
              "submodule": "${{ steps.config.outputs.submodule }}",
              "sha": "${{ steps.source.outputs.sha }}",
              "lane": "${{ steps.source.outputs.lane }}",
              "source_repo": "${{ steps.source.outputs.source_repo }}",
              "source_branch": "${{ steps.source.outputs.lane }}"
            }
